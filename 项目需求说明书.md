# 本地离线语音助手（Wake-Word Desktop Assistant）需求说明

## 1. 项目目标

构建一个运行在 **Windows 11 笔记本上的本地离线语音助手**，具备以下能力：

- 常驻后台，**持续监听麦克风**
- 通过 **固定中文唤醒词** 进入工作状态
- 唤醒后自动录音并进行 **本地语音识别（ASR）**
- 将识别文本解析为明确指令
- 通过 **MCP（Model Context Protocol）工具**执行操作
- 当前阶段仅支持：**打开文件**
- 架构需具备良好的 **可扩展性**，便于后续增加更多 MCP 工具能力

---

## 2. 核心设计原则

- **离线优先**：唤醒词检测、语音识别均在本地完成
- **模块解耦**：唤醒 / 录音 / ASR / 指令解析 / MCP 执行相互独立
- **安全可控**：不允许模型或规则直接执行任意系统命令
- **事件驱动**：通过状态机或事件流驱动各模块协作
- **先规则，后 LLM**：当前阶段不依赖大模型进行意图理解

---

## 3. 运行环境

- 操作系统：Windows 11
- 语言：Python 3.x
- 麦克风：系统默认输入设备
- 运行方式：后台常驻进程（无 GUI 也可）
- 使用rich包美化终端输出

---

## 4. 功能范围（阶段一）

### 4.1 唤醒词（Wake Word）

- 使用 **固定中文唤醒词**
- 唤醒模块需满足：
  - 低延迟
  - 低误唤醒率
  - 离线运行
- 唤醒成功后：
  - 进入录音状态
  - 在一定时间内进入 cooldown，防止重复唤醒

---

### 4.2 语音录音与静音检测

- 唤醒后自动开始录音
- 使用 **VAD（语音活动检测）** 判断语音结束
- 录音要求：
  - 16kHz
  - mono
  - 16-bit PCM
- 支持 **音频回溯（pre-roll）**：
  - 在正式录音前，自动拼接 0.5–1.0 秒的历史音频
  - 防止漏掉唤醒词后的第一句话

---

### 4.3 本地语音识别（ASR）

- 使用本地模型完成中文语音识别
- 输出完整文本字符串
- 不要求实时流式识别
- 可接受略高延迟（1–3 秒级）

---

### 4.4 指令解析（规则优先）

当前阶段仅需支持以下指令意图：

#### 打开文件（open_file）

支持的典型表达：
- “打开 XXX”
- “帮我打开 XXX”
- “开启 XXX”
- “XXX 打开一下”

解析目标：
- intent: `open_file`
- target: 文件名 / 文件关键词 / 路径字符串

若无法明确解析：
- 返回 `unknown`
- 允许进入澄清流程（后续阶段）

---

### 4.5 MCP 工具调用

#### MCP Server

MCP server，至少支持以下工具：

##### `find_file`
- 输入：
  - query（关键词）
  - base_dirs（搜索根目录）
  - limit
- 输出：
  - 候选文件路径列表

##### `open_file`
- 输入：
  - target（路径或文件标识）
- 输出：
  - status
  - resolved_path
  - message

#### MCP Client（本项目）

- 负责调用 MCP server
- 不包含任何系统执行逻辑
- 所有文件操作必须通过 MCP 完成

---

## 5. 状态机设计

系统至少包含以下状态：

- `IDLE`
  - 常驻监听
  - 仅进行唤醒词检测

- `LISTENING`
  - 已唤醒
  - 进行语音录音
  - VAD 判断结束条件

- `THINKING`
  - ASR 转写
  - 指令解析
  - 决定是否调用 MCP

- `EXECUTING`
  - 调用 MCP 工具
  - 接收执行结果

- 返回 `IDLE`

---

## 6. 非功能性需求

### 6.1 安全

- MCP 工具需自行处理：
  - 路径规范化
  - 目录白名单
  - 防止路径穿越
- 本项目不允许直接执行 shell / PowerShell 命令

---

### 6.2 可扩展性

后续应可扩展为：
- 打开应用（open_app）
- 打开网页（open_url）
- 控制系统设置
- 接入 LLM 进行复杂意图理解

扩展时不应破坏现有模块接口。

---

## 7. 推荐项目结构

voice_assistant/
├── main.py # 程序入口（根目录仅保留该入口文件）
├── voice_assistant/
│   ├── __init__.py
│   ├── audio_stream.py # 音频采集 + ring buffer
│   ├── wakeword.py # 唤醒词检测
│   ├── vad_recorder.py # VAD + 录音逻辑
│   ├── asr.py # 本地语音识别
│   ├── parser.py # 规则意图解析
│   ├── mcp_client.py # MCP 调用封装
│   └── state_machine.py # 状态管理
└── mcptool/
    ├── __init__.py
    ├── find_file.py # MCP 工具：文件检索
    └── open_file.py # MCP 工具：打开文件


---

## 8. 当前阶段不包含的内容（明确排除）

- ❌ 大模型意图理解
- ❌ 云端 ASR
- ❌ GUI / 前端界面
- ❌ 用户账号系统
- ❌ 权限弹窗或复杂交互 UI

---

## 9. 验收标准（阶段一）

- 程序可常驻运行
- 说出唤醒词后进入录音
- 能正确识别“打开 XXX”类指令
- 能成功调用 MCP 打开对应文件
- 执行完成后返回待机状态

